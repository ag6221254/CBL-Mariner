From a42aa505b556db0d998fc2a6204992fbee6c22ad Mon Sep 17 00:00:00 2001
From: Jim Derry <balthisar@gmail.com>
Date: Sat, 31 Jul 2021 08:26:16 -0400
Subject: [PATCH] Fixes #946 by refactoring the recursion into a loop with a
 heap-based stack.

---
 .../cases/github-cases/case-946.conf          |   3 +
 .../cases/github-cases/case-946@1.html        | Bin 0 -> 11558 bytes
 .../cases/github-expects/case-946.html        |  44 +++
 .../cases/github-expects/case-946.txt         | 330 ++++++++++++++++++
 src/gdoc.c                                    |  11 +-
 5 files changed, 385 insertions(+), 3 deletions(-)
 create mode 100755 regression_testing/cases/github-cases/case-946.conf
 create mode 100644 regression_testing/cases/github-cases/case-946@1.html
 create mode 100644 regression_testing/cases/github-expects/case-946.html
 create mode 100644 regression_testing/cases/github-expects/case-946.txt

diff --git a/regression_testing/cases/github-cases/case-946.conf b/regression_testing/cases/github-cases/case-946.conf
new file mode 100755
index 0000000..16ee2e7
--- /dev/null
+++ b/regression_testing/cases/github-cases/case-946.conf
@@ -0,0 +1,3 @@
+# Sample config for 946
+gdoc: yes
+wrap: 999
diff --git a/regression_testing/cases/github-cases/case-946@1.html b/regression_testing/cases/github-cases/case-946@1.html
new file mode 100644
index 0000000000000000000000000000000000000000..aafb1a56a9129a3c348ca69bce36059ceeda7042
GIT binary patch
literal 11558
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

literal 0
HcmV?d00001

diff --git a/regression_testing/cases/github-expects/case-946.html b/regression_testing/cases/github-expects/case-946.html
new file mode 100644
index 0000000..655ae03
--- /dev/null
+++ b/regression_testing/cases/github-expects/case-946.html
@@ -0,0 +1,44 @@
+<!DOCTYPE html>
+<html>
+<head>
+<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
+<title></title>
+</head>
+<body>
+<div><svg>&lt;"r&gt;<br html=""></svg></div>
+<worm action="/search" name="f">
+<table cellpadding="0" cellspacing="0">
+<ttype submitr valign="top">
+<td width="25%">&amp;nbsp;</td>
+-align="center" nowrap=""&gt;me=rap=""&gt;me="i�" value="ISO�8859-1" type="hidden"&gt;<input value="en-IN" name="hl" type="hidde�"></ttype>
+</table>
+</worm>
+</body>
+</html>gleg/1x/googleg_standard_color_128dp.png" itemprop="image"&gt;
+<title>Google</title>
+<script nonce="hMG7fVnzx1oD0vxr6p+w8A==">
+(function(){window.google={kEI:'X5iRYMLBHIea4-EPu-6-4Ag',kEXPI:'0,18167,1284369,56873,954,5104,207,4804,2316,383,246,5,306,1048,5250,1122516,1232,1196540,510,44,1,302635,26305,51224,16114,28684,7572,4858,1362,9291,3022,3895,850,6,12835,4020,978,13228,2054,1793,3600,592,6430,1141,7512,5874,4518,2777,919,2277,8,2796,1593,1279,1042,1170,530,149,1103,840,517,1522,4258,3514,606,2023,1777,520,4269,330,1282,8789,3227,2845,7,12354,5096,7877,4928,108,3407,908,2,941,2614,2397,7468,3277,3,346,230,1014,1,820,7,2543,2074,14[,5990,5333,2652,4,1528,2304,1236,5803,74,1717,266,2626,2015,4067,7434,3824,1297,1753,2658,4242,519,912,564,1119,31,3854,7155,405,2214,2305,638,1494,5586,10535,665,2145,376,3306,2302,228,2048,906,1140,19,3120,5,613,295,3,1902,1639,1,4174,10536,1814,38,245,912,60,5932,1260,T194,2,4298,400,32,2859,876,1605,2,1394,1525,8,1273,1721,2,482,1922,647,2548,2713,287,20,758,456,3,33,3,60,3,471,1704,2,564,1960,718,530,2,61,174,444,166,88,126,41,493,350,2,597,505,922,3,80,11,2044,230,56,1275,1262,69,205,865,1771,406,1576,3,768,194,126,828,202,171,393,887,265,40,1895,108,934,350,339,/schema.org/WebPage" lang="en-IN">
+<head>
+<meta>
+</head>
+</script>
+<style>
+#gbar,#guser{font-size:13px;padding-top:1px !important;}#gbar{height:22px}#guser{padding-bottom:7px !important;text-align:right}.gbh,.gbd{border-top:1px solid #c9d7f1;font-size:1px}.gbh{height:0;position:absolute;top:24px;width:100%}@media all{.gb1{height:22px;margin-right:.5em;vertical-align:top}#gbar{float:left}}a.gb1,a.gb4{text-decoration:underline !important}a.gb1,a.gb4{color:#00c !important}.gbi .gb4{color:#dd8e27 !important}.gbf .gb4{color:#900 !important}
+</style>
+<style>
+body,td,a,p,.h{font-family:arial,sans-serif}body{margin:0;overflow-y:scroll}#gog{padding:3px 8px 0}td{line-height:.8em}.gac_m td{line-height:17px}form{margin-bottom:20px}.h{color:#1558d6}emt-weight:bold;font-style:normal}.lst{height:25px;width:496px}.gsfi,.lst{font:18px arial,sbb"-serif}.gsfs{font:17px arial,sans-serif}.ds{display:inline-box;display:inline-block;margin:3px 0 4px;margin-left:4px}input{font-family:inherit}body{background:#fff;color:#000}a{color:#4b11a8;text-decoration:none}a:hover,a:active{text-decoration:underline}.fl a{color:#1558d6}a:visited{color:#4b11a8}.sblc{padding-top:5px}.sblc a{display:block;margin:2px 0;margin-left:13px;font-size:11px}.lsbb{background:#f8f9fa;border:solid 1px;border-color:#dadce0 #70757a #70757a #dadce0;height:30px}.lsbb{display:block}#WqQANb a{display:inline-block;margin:0 12px}.lsb{background:url(/images/nav_logo229.png) 0 -261px repeat-x;border:none;color:#000;cursor:pointer;height:30px;margin:0;outline:0;font:15px arial,sans-serif;vertical-align:top}.lsb:ac�{background:#dadce0}.lst:focus{outline:none}0/style>
+<script nonce="hMG7fVnzx1oD0vxr6p+w8A=="></script>
+<body bgcolor="#fff">
+<script nonce="hMG7fVnzx1oD0vxr6p+w8A==">
+(function(){var src='/images/nav_logo229.png';var iesg=false;document.body.onload = function(){window.n && window.n();if (document.images){new Image().src=src;} if (!iesg){document.f&&document.f.q.focus();document.gbqf&&document.gbqf.q.focus();} } })();
+</script>
+<div id="mngb">
+<div id="gbar"><nobr><b class="gb1">Search</b> <a class="gb1" href="http://www.google.co.in/imghp?hl=en&amp;tab=wi">Images</a> <a class="gb1" href="http://maps.google.co.in/maps?hl=en&amp;tab=wl">Maps</a> <a class="gb1" href="https://play.google.com/?hl=en&amp;tab=w8">Play</a> <a class="gb1" href="http://www.youtube.com/?gl=IN&amp;tab=w1">YouTube</a> <a class="gb1" href="https://news.google.com/?tab=wn">News</a> <a class="gb1" href="https://mail.google.com/mail/?tab=wm">Gmail</a> <a class="gb1" href="https://drive.google.com/?tab=wo">Drive</a> <a class="gb1" style="text-decoration:none" href="https://www.google.co.in/intl/en/about/products?tab=wh"><u>More</u> &raquo;</a></nobr></div>
+<div id="guser" width="100%"><nobr><a href="http://www.google.co.in/history/optoux?hl=en" class="gb4">Web History</a> | <a href="/preferences?hl=en" class="gb4">Settings</a> | <a target="_top" id="gb_70" href="https://accounts.google.com/ServiceLogin?hl=en&amp;passive=true&amp;continue=http://www.google.com/&amp;ec=GAZAAQ" class="gb4">Sign in</a></nobr></div>
+<div class="gbh" style="left:0"></div>
+<div class="gbh" style="right:0">=/div></div>
+<center><br clear="all" id="lgpd"></center>
+</div>
+<br style="line-height:0">
+</body>
+</style>
diff --git a/regression_testing/cases/github-expects/case-946.txt b/regression_testing/cases/github-expects/case-946.txt
new file mode 100644
index 0000000..ce45d7a
--- /dev/null
+++ b/regression_testing/cases/github-expects/case-946.txt
@@ -0,0 +1,330 @@
+line 1 column 1 - Warning: discarding malformed <!DOCTYPE>
+line 1 column 26 - Warning: replacing invalid UTF-8 bytes (char. code U+00A5)
+line 1 column 27 - Warning: replacing invalid UTF-8 bytes (char. code U+009F)
+line 1 column 32 - Warning: replacing invalid UTF-8 bytes (char. code U+008D)
+line 1 column 33 - Warning: replacing invalid UTF-8 bytes (char. code U+008D)
+line 1 column 20 - Warning: <div> attribute name "i��ioz{��~" (value="la") is invalid
+line 1 column 33 - Warning: inserting implicit <body>
+line 1 column 41 - Warning: <svg> attribute with missing trailing quote mark
+line 1 column 56 - Warning: <br> attribute "!doctype" lacks value
+line 1 column 114 - Warning: replacing invalid UTF-8 bytes (char. code U+0080)
+line 1 column 216 - Warning: <meta> attribute with missing trailing quote mark
+line 1 column 216 - Warning: <meta> attribute with missing trailing quote mark
+line 1 column 318 - Warning: missing </br> before <br>
+line 1 column 216 - Warning: missing </meta> before <br>
+line 1 column 148 - Warning: missing </meta> before <meta>
+line 1 column 142 - Warning: missing </head> before <meta>
+line 1 column 74 - Warning: missing </html> before <head>
+line 1 column 56 - Warning: missing </br> before <html>
+line 1 column 41 - Warning: missing </svg> before <br>
+line 1 column 20 - Warning: missing </div> before <svg>
+line 1 column 403 - Warning: <ttype> unexpected or duplicate quote mark
+line 1 column 500 - Warning: replacing invalid UTF-8 bytes (char. code U+0083)
+line 1 column 513 - Warning: replacing invalid UTF-8 bytes (char. code U+0000)
+line 1 column 578 - Warning: replacing invalid UTF-8 bytes (char. code U+0091)
+line 2 column 114 - Warning: <input> attribute with missing trailing quote mark
+line 2 column 156 - Warning: replacing invalid UTF-8 bytes (char. code U+0080)
+line 2 column 168 - Warning: replacing invalid UTF-8 bytes (char. code U+008D)
+line 2 column 169 - Warning: replacing invalid UTF-8 bytes (char. code U+008D)
+line 2 column 25 - Warning: missing </input> before <input>
+line 1 column 581 - Warning: missing </input> before <input>
+line 1 column 536 - Warning: missing </input> before <input>
+line 1 column 403 - Warning: missing </ttype> before <input>
+line 1 column 364 - Warning: missing </table> before <ttype>
+line 1 column 332 - Warning: missing </worm> before <table>
+line 1 column 33 - Warning: missing </body> before <worm>
+line 1 column 1 - Warning: missing </html> before <body>
+line 2 column 193 - Warning: replacing invalid UTF-8 bytes (char. code U+0091)
+line 2 column 177 - Warning: discarding unexpected </html>
+line 2 column 1448 - Warning: <meta> attribute "conten/body" lacks value
+line 2 column 1466 - Warning: discarding unexpected </html>
+line 2 column 1515 - Warning: <meta> attribute with missing trailing quote mark
+line 2 column 1596 - Warning: discarding unexpected </title6>
+line 2 column 1709 - Warning: replacing invalid UTF-8 bytes (char. code U+00FF)
+line 2 column 2542 - Warning: replacing invalid UTF-8 bytes (char. code U+00B5)
+line 2 column 2909 - Warning: replacing invalid UTF-8 bytes (char. code U+0005)
+line 4 column 49 - Warning: unescaped & or unknown entity "&ei"
+line 4 column 61 - Warning: unescaped & or unknown entity "&ei"
+line 4 column 86 - Warning: unescaped & or unknown entity "&lei"
+line 4 column 110 - Warning: unescaped & or unknown entity "&lei"
+line 4 column 129 - Warning: unescaped & or unknown entity "&window._cshid"
+line 4 column 144 - Warning: unescaped & or unknown entity "&-1"
+line 4 column 159 - Warning: unescaped & or unknown entity "&cshid"
+line 4 column 184 - Warning: unescaped & or unknown entity "&cshid"
+line 4 column 240 - Warning: unescaped & or unknown entity "&ct"
+line 4 column 246 - Warning: replacing invalid UTF-8 bytes (char. code U+00FF)
+line 4 column 247 - Warning: replacing invalid UTF-8 bytes (char. code U+00FF)
+line 4 column 249 - Warning: unescaped & or unknown entity "&cad"
+line 4 column 261 - Warning: unescaped & or unknown entity "&zx"
+line 4 column 346 - Warning: unescaped & or unknown entity "&google.ml"
+line 4 column 619 - Warning: replacing invalid UTF-8 bytes (char. code U+001D)
+line 4 column 619 - Warning: <area> attribute "(a)*a;l" lacks value
+line 4 column 632 - Warning: replacing invalid UTF-8 bytes (char. code U+00FF)
+line 4 column 633 - Warning: replacing invalid UTF-8 bytes (char. code U+00FF)
+line 4 column 619 - Warning: <area> attribute "h(ao��widte" lacks value
+line 4 column 619 - Warning: <area> attribute name "h[e]};a.src" (value="c}};google.logUrl=m;}).call(thi);(function(){") is invalid
+line 5 column 25 - Warning: replacing invalid UTF-8 bytes (char. code U+0010)
+line 4 column 619 - Info: value for attribute "google.y" missing quote marks
+line 4 column 619 - Info: value for attribute "c" missing quote marks
+line 4 column 619 - Info: value for attribute "c" missing quote marks
+line 4 column 619 - Warning: <area> attribute "document.documentelement.addeventlistener("submit",function(b){var" lacks value
+line 4 column 619 - Warning: <area> attribute name "a;if(a" (value="b.target){var") is invalid
+line 6 column 184 - Warning: replacing invalid UTF-8 bytes (char. code U+00FF)
+line 6 column 185 - Warning: replacing invalid UTF-8 bytes (char. code U+00FF)
+line 6 column 186 - Warning: replacing invalid UTF-8 bytes (char. code U+00FF)
+line 6 column 187 - Warning: replacing invalid UTF-8 bytes (char. code U+008D)
+line 4 column 619 - Info: value for attribute "c" missing quote marks
+line 6 column 321 - Warning: unescaped & or unknown entity "&a"
+line 4 column 619 - Warning: <area> attribute name "ion())},!0);document.documentelement.addeventlistener("click",function(b){var0a;a:{for(a" (value="b.target;a&&a!=document.documentElement;a=a.parentElement)if("A"==a.tagName){a="1"==a.getAttribute("data-nohref");break") is invalid
+line 6 column 439 - Warning: unescaped & or unknown entity "&b.preventDefault"
+line 4 column 619 - Warning: <area> missing '>' for end of tag
+line 4 column 619 - Warning: <area> attribute name "a}a" (value="!1}a&&b.preventDefault()},!0);}).call(this);") is invalid
+line 4 column 619 - Warning: <area> dropping value "a.id;else{do" for repeated attribute "c"
+line 4 column 619 - Warning: <area> dropping value "Math.random();while(google.y[c])}google.y[c]=[a,b];return!1};google.sx=f64,1960,718,530,2,61,174,44unction(a){google.sy.push(a)};google.lm=[];google.plm=function(a){google.lm.push.apply(google.lm,a)};google.lq=[];google.load=function(a,b,c){google.lq.push([[a],b,c])};google.loadAll=function(a,b){google.lq.push([a,b])};google.bx=!1;google.lx=function(){};}).call(this);google.f={};(function(){" for repeated attribute "c"
+line 2 column 1583 - Warning: missing </title> before <area>
+line 2 column 1515 - Warning: missing </meta> before <title>
+line 2 column 1448 - Warning: missing </meta> before <meta>
+line 2 column 1442 - Warning: missing </head> before <meta>
+line 2 column 275 - Warning: missing </script> before <head>
+line 7 column 1034 - Warning: replacing invalid UTF-8 bytes (char. code U+00BC)
+line 7 column 1137 - Warning: discarding unexpected </head>
+line 8 column 23 - Warning: unescaped & or unknown entity "&document.f.q.focus"
+line 8 column 59 - Warning: unescaped & or unknown entity "&document.gbqf.q.focus"
+line 10 column 30 - Info: value for attribute "id" missing quote marks
+line 10 column 49 - Info: value for attribute "class" missing quote marks
+line 10 column 73 - Info: value for attribute "class" missing quote marks
+line 10 column 127 - Warning: unescaped & or unknown entity "&tab"
+line 10 column 147 - Info: value for attribute "class" missing quote marks
+line 10 column 201 - Warning: unescaped & or unknown entity "&tab"
+line 10 column 219 - Info: value for attribute "class" missing quote marks
+line 10 column 268 - Warning: unescaped & or unknown entity "&tab"
+line 10 column 286 - Info: value for attribute "class" missing quote marks
+line 10 column 334 - Warning: unescaped & or unknown entity "&tab"
+line 10 column 355 - Info: value for attribute "class" missing quote marks
+line 10 column 416 - Info: value for attribute "class" missing quote marks
+line 10 column 483 - Info: value for attribute "class" missing quote marks
+line 10 column 546 - Info: value for attribute "class" missing quote marks
+line 10 column 686 - Info: value for attribute "id" missing quote marks
+line 10 column 686 - Info: value for attribute "width" missing quote marks
+line 10 column 717 - Info: value for attribute "id" missing quote marks
+line 10 column 717 - Info: value for attribute "class" missing quote marks
+line 10 column 747 - Info: value for attribute "id" missing quote marks
+line 10 column 747 - Info: value for attribute "class" missing quote marks
+line 10 column 777 - Info: value for attribute "id" missing quote marks
+line 10 column 797 - Info: value for attribute "class" missing quote marks
+line 10 column 880 - Info: value for attribute "class" missing quote marks
+line 10 column 935 - Info: value for attribute "target" missing quote marks
+line 10 column 935 - Info: value for attribute "id" missing quote marks
+line 10 column 1011 - Warning: unescaped & or unknown entity "&passive"
+line 10 column 1024 - Warning: unescaped & or unknown entity "&continue"
+line 10 column 1056 - Warning: unescaped & or unknown entity "&ec"
+line 10 column 935 - Info: value for attribute "class" missing quote marks
+line 10 column 1102 - Info: value for attribute "class" missing quote marks
+line 10 column 1102 - Info: value for attribute "style" missing quote marks
+line 10 column 1136 - Info: value for attribute "class" missing quote marks
+line 10 column 1136 - Info: value for attribute "style" missing quote marks
+line 10 column 1391 - Warning: missing </br> before <br>
+line 10 column 1225 - Warning: missing </img> before <br>
+line 10 column 1211 - Warning: missing </div> before <img>
+line 10 column 1493 - Info: value for attribute "width" missing quote marks
+line 10 column 1753 - Warning: missing </dlv> before <input>
+line 10 column 1721 - Warning: missing </input> before <dlv>
+line 10 column 1689 - Warning: missing </input> before <input>
+line 10 column 1643 - Warning: missing </input> before <input>
+line 10 column 1598 - Warning: missing </input> before <input>
+line 10 column 1548 - Warning: missing </input> before <input>
+line 10 column 1519 - Warning: missing </td> before <input>
+line 10 column 1476 - Warning: missing </tr> before <td>
+line 10 column 1437 - Warning: missing </table> before <tr>
+line 10 column 1405 - Warning: missing </form> before <table>
+line 10 column 1185 - Warning: missing </br> before <form>
+line 10 column 1177 - Warning: missing </center> before <br>
+line 10 column 15 - Warning: missing </div> before <center>
+line 10 column 2025 - Warning: missing </span> before <input>
+line 10 column 2161 - Warning: missing </input> before <input>
+line 10 column 2142 - Warning: missing </span> before <input>
+line 11 column 149 - Warning: discarding unexpected </td>
+line 11 column 155 - Warning: replacing invalid UTF-8 bytes (char. code U+00FF)
+line 11 column 156 - Warning: replacing invalid UTF-8 bytes (char. code U+00FF)
+line 11 column 277 - Warning: discarding unexpected </td>
+line 11 column 282 - Warning: discarding unexpected </tr>
+line 11 column 287 - Warning: discarding unexpected </table>
+line 12 column 25 - Warning: unescaped & or unknown entity "&document.getElementById"
+line 1 column 20 - Warning: missing </div>
+line 1 column 20 - Warning: missing </div>
+line 1 column 33 - Warning: inserting missing 'title' element
+line 4 column 619 - Warning: <area> lacks "alt" attribute
+line 4 column 619 - Warning: <area> lacks "href" attribute
+line 10 column 1225 - Warning: <img> lacks "alt" attribute
+line 10 column 1225 - Warning: <img> lacks "src" attribute
+line 10 column 717 - Warning: trimming empty <span>
+line 10 column 747 - Warning: trimming empty <span>
+line 10 column 777 - Warning: trimming empty <span>
+line 10 column 1177 - Warning: <center> element removed from HTML5
+line 1 column 56 - Warning: <br> proprietary attribute "html"
+line 1 column 74 - Warning: <html> proprietary attribute "itemscope"
+line 1 column 74 - Warning: <html> proprietary attribute "itemtype"
+line 1 column 74 - Warning: <html> proprietary attribute "lang"
+line 1 column 148 - Warning: <meta> proprietary attribute "content"
+line 1 column 148 - Warning: <meta> proprietary attribute "http-equiv"
+line 1 column 216 - Warning: <meta> proprietary attribute "content"
+line 1 column 216 - Warning: <meta> proprietary attribute "style"
+line 1 column 364 - Warning: <table> proprietary attribute "cellpadding"
+line 1 column 364 - Warning: <table> proprietary attribute "cellspacing"
+line 1 column 432 - Warning: <td> proprietary attribute "width"
+line 1 column 536 - Warning: <input> proprietary attribute "value"
+line 1 column 536 - Warning: <input> proprietary attribute "name"
+line 1 column 536 - Warning: <input> proprietary attribute "type"
+line 1 column 581 - Warning: <input> proprietary attribute "name"
+line 1 column 581 - Warning: <input> proprietary attribute "tg"
+line 1 column 581 - Warning: <input> proprietary attribute "ype"
+line 1 column 581 - Warning: <input> proprietary attribute "value"
+line 2 column 25 - Warning: <input> proprietary attribute "name"
+line 2 column 25 - Warning: <input> proprietary attribute "type"
+line 2 column 275 - Warning: <script> proprietary attribute "nonce"
+line 2 column 1515 - Warning: <meta> proprietary attribute "itemprop"
+line 4 column 619 - Warning: <area> proprietary attribute "google.y"
+line 4 column 619 - Warning: <area> proprietary attribute "c"
+line 7 column 1087 - Warning: <script> proprietary attribute "nonce"
+line 7 column 1144 - Warning: <body> proprietary attribute "bgcolor"
+line 7 column 1165 - Warning: <script> proprietary attribute "nonce"
+line 10 column 15 - Warning: <div> proprietary attribute "id"
+line 10 column 30 - Warning: <div> proprietary attribute "id"
+line 10 column 43 - Warning: <nobr> is not approved by W3C
+line 10 column 49 - Warning: <b> proprietary attribute "class"
+line 10 column 73 - Warning: <a> proprietary attribute "class"
+line 10 column 73 - Warning: <a> proprietary attribute "href"
+line 10 column 147 - Warning: <a> proprietary attribute "class"
+line 10 column 147 - Warning: <a> proprietary attribute "href"
+line 10 column 219 - Warning: <a> proprietary attribute "class"
+line 10 column 219 - Warning: <a> proprietary attribute "href"
+line 10 column 286 - Warning: <a> proprietary attribute "class"
+line 10 column 286 - Warning: <a> proprietary attribute "href"
+line 10 column 355 - Warning: <a> proprietary attribute "class"
+line 10 column 355 - Warning: <a> proprietary attribute "href"
+line 10 column 416 - Warning: <a> proprietary attribute "class"
+line 10 column 416 - Warning: <a> proprietary attribute "href"
+line 10 column 483 - Warning: <a> proprietary attribute "class"
+line 10 column 483 - Warning: <a> proprietary attribute "href"
+line 10 column 546 - Warning: <a> proprietary attribute "class"
+line 10 column 546 - Warning: <a> proprietary attribute "style"
+line 10 column 546 - Warning: <a> proprietary attribute "href"
+line 10 column 686 - Warning: <div> proprietary attribute "id"
+line 10 column 686 - Warning: <div> proprietary attribute "width"
+line 10 column 711 - Warning: <nobr> is not approved by W3C
+line 10 column 797 - Warning: <a> proprietary attribute "href"
+line 10 column 797 - Warning: <a> proprietary attribute "class"
+line 10 column 880 - Warning: <a> proprietary attribute "href"
+line 10 column 880 - Warning: <a> proprietary attribute "class"
+line 10 column 935 - Warning: <a> proprietary attribute "target"
+line 10 column 935 - Warning: <a> proprietary attribute "id"
+line 10 column 935 - Warning: <a> proprietary attribute "href"
+line 10 column 935 - Warning: <a> proprietary attribute "class"
+line 10 column 1102 - Warning: <div> proprietary attribute "class"
+line 10 column 1102 - Warning: <div> proprietary attribute "style"
+line 10 column 1136 - Warning: <div> proprietary attribute "class"
+line 10 column 1136 - Warning: <div> proprietary attribute "style"
+line 10 column 1185 - Warning: <br> proprietary attribute "clear"
+line 10 column 1185 - Warning: <br> proprietary attribute "id"
+line 10 column 1211 - Warning: <div> proprietary attribute "id"
+line 10 column 1225 - Warning: <img> proprietary attribute "alt"
+line 10 column 1225 - Warning: <img> proprietary attribute "height"
+line 10 column 1225 - Warning: <img> proprietary attribute "src"
+line 10 column 1225 - Warning: <img> proprietary attribute "style"
+line 10 column 1225 - Warning: <img> proprietary attribute "width"
+line 10 column 1225 - Warning: <img> proprietary attribute "id"
+line 10 column 1405 - Warning: <form> proprietary attribute "action"
+line 10 column 1405 - Warning: <form> proprietary attribute "name"
+line 10 column 1437 - Warning: <table> proprietary attribute "cellpadding"
+line 10 column 1437 - Warning: <table> proprietary attribute "cellspacing"
+line 10 column 1476 - Warning: <tr> proprietary attribute "valign"
+line 10 column 1493 - Warning: <td> proprietary attribute "width"
+line 10 column 1519 - Warning: <td> proprietary attribute "align"
+line 10 column 1519 - Warning: <td> proprietary attribute "nowrap"
+line 10 column 1548 - Warning: <input> proprietary attribute "name"
+line 10 column 1548 - Warning: <input> proprietary attribute "value"
+line 10 column 1548 - Warning: <input> proprietary attribute "type"
+line 10 column 1598 - Warning: <input> proprietary attribute "value"
+line 10 column 1598 - Warning: <input> proprietary attribute "name"
+line 10 column 1598 - Warning: <input> proprietary attribute "type"
+line 10 column 1643 - Warning: <input> proprietary attribute "name"
+line 10 column 1643 - Warning: <input> proprietary attribute "type"
+line 10 column 1643 - Warning: <input> proprietary attribute "value"
+line 10 column 1689 - Warning: <input> proprietary attribute "name"
+line 10 column 1689 - Warning: <input> proprietary attribute "type"
+line 10 column 1721 - Warning: <input> proprietary attribute "name"
+line 10 column 1721 - Warning: <input> proprietary attribute "type"
+line 10 column 1802 - Warning: <input> proprietary attribute "class"
+line 10 column 1802 - Warning: <input> proprietary attribute "style"
+line 10 column 1802 - Warning: <input> proprietary attribute "autocomplete"
+line 10 column 1802 - Warning: <input> proprietary attribute "value"
+line 10 column 1802 - Warning: <input> proprietary attribute "title"
+line 10 column 1802 - Warning: <input> proprietary attribute "maxlength"
+line 10 column 1802 - Warning: <input> proprietary attribute "name"
+line 10 column 1802 - Warning: <input> proprietary attribute "size"
+line 10 column 1982 - Warning: <br> proprietary attribute "style"
+line 10 column 2008 - Warning: <span> proprietary attribute "class"
+line 10 column 2025 - Warning: <span> proprietary attribute "class"
+line 10 column 2044 - Warning: <input> proprietary attribute "class"
+line 10 column 2044 - Warning: <input> proprietary attribute "value"
+line 10 column 2044 - Warning: <input> proprietary attribute "name"
+line 10 column 2044 - Warning: <input> proprietary attribute "type"
+line 10 column 2125 - Warning: <span> proprietary attribute "class"
+line 10 column 2142 - Warning: <span> proprietary attribute "class"
+line 10 column 2161 - Warning: <input> proprietary attribute "class"
+line 10 column 2161 - Warning: <input> proprietary attribute "lue"
+line 10 column 2161 - Warning: <input> proprietary attribute "name"
+line 10 column 2161 - Warning: <input> proprietary attribute "type"
+line 10 column 2229 - Warning: <script> proprietary attribute "nonce"
+line 11 column 47 - Warning: <input> proprietary attribute "value"
+line 11 column 47 - Warning: <input> proprietary attribute "name"
+line 11 column 47 - Warning: <input> proprietary attribute "type"
+line 11 column 207 - Warning: <a> proprietary attribute "href"
+line 11 column 295 - Warning: <input> proprietary attribute "id"
+line 11 column 295 - Warning: <input> proprietary attribute "name"
+line 11 column 295 - Warning: <input> proprietary attribute "type"
+line 11 column 295 - Warning: <input> proprietary attribute "value"
+line 11 column 346 - Warning: <script> proprietary attribute "nonce"
+Info: Document content looks like HTML5
+Tidy found 256 warnings and 0 errors!
+
+Character codes for UTF-8 must be in the range: U+0000 to U+10FFFF.
+The definition of UTF-8 in Annex D of ISO/IEC 10646-1:2000 also
+allows for the use of five- and six-byte sequences to encode
+characters that are outside the range of the Unicode character set;
+those five- and six-byte sequences are illegal for the use of
+UTF-8 as a transformation of Unicode characters. ISO/IEC 10646
+does not allow mapping of unpaired surrogates, nor U+FFFE and U+FFFF
+(but it does allow other noncharacters). For more information please refer to
+https://home.unicode.org/ and https://www.cl.cam.ac.uk/~mgk25/unicode.html
+
+The alt attribute should be used to give a short description
+of an image; longer descriptions should be given with the
+longdesc attribute which takes a URL linked to the description.
+These measures are needed for people using non-graphical browsers.
+
+For hypertext links defined using a client-side image map, you
+need to use the alt attribute to provide a textual description
+of the link for people using non-graphical browsers.
+
+For further advice on how to make your pages accessible
+see https://www.w3.org/WAI/GL.
+You are recommended to use CSS to control line wrapping.
+Use "white-space: nowrap" to inhibit wrapping in place
+of inserting <NOBR>...</NOBR> into the markup.
+
+One or more empty elements were present in the source document but
+dropped on output. If these elements are necessary or you don't want
+this behavior, then consider setting the option "drop-empty-elements"
+to no.
+
+About HTML Tidy: https://github.com/htacg/tidy-html5
+Bug reports and comments: https://github.com/htacg/tidy-html5/issues
+Official mailing list: https://lists.w3.org/Archives/Public/public-htacg/
+Latest HTML specification: https://html.spec.whatwg.org/multipage/
+Validate your HTML documents: https://validator.w3.org/nu/
+Lobby your company to join the W3C: https://www.w3.org/Consortium
+
+Do you speak a language other than English, or a different variant of
+English? Consider helping us to localize HTML Tidy. For details please see
+https://github.com/htacg/tidy-html5/blob/master/README/LOCALIZE.md
diff --git a/src/gdoc.c b/src/gdoc.c
index 50cd9bc..75cc12f 100644
--- a/src/gdoc.c
+++ b/src/gdoc.c
@@ -96,11 +96,12 @@ static void DiscardContainer( TidyDocImpl* doc, Node *element, Node **pnode)
 
 static void CleanNode( TidyDocImpl* doc, Node *node )
 {
+    Stack *stack = TY_(newStack)(doc, 16);
     Node *child, *next;
 
-    if (node->content)
+    if ( (child = node->content) )
     {
-        for (child = node->content; child != NULL; child = next)
+        while (child)
         {
             next = child->next;
 
@@ -131,10 +132,14 @@ static void CleanNode( TidyDocImpl* doc, Node *node )
                     if (child->attributes)
                         TY_(DropAttrByName)( doc, child, "class" );
 
-                    CleanNode(doc, child);
+                    TY_(push)(stack,next);
+                    child = child->content;
+                    continue;
                 }
             }
+            child = next ? next : TY_(pop)(stack);
         }
+        TY_(freeStack)(stack);
     }
 }
 
-- 
2.38.1

